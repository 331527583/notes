 
# 硬盘接口的比较  
 
**目录**

* 磁盘阵列与存储接口技术发展回顾
* 企业级服务器硬盘市场趋势
* 磁盘阵列内部接口技术比较
* SAS磁盘和FC磁盘比较
* IDE (P-ATA) 并行ATA 磁盘
* SATA (S-ATA)串行ATA 磁盘
* SCSI 磁盘
* FC 光纤通道 磁盘
* SAS 磁盘
* SAS协议
* SCSI-3指令集


## 磁盘阵列与存储接口技术发展回顾
 
![1](http://way4ever.com/wp-content/uploads/2013/04/d1.jpg)

***
 
## 企业级服务器硬盘市场趋势

![1](http://way4ever.com/wp-content/uploads/2013/04/d2.jpg)
***

## 磁盘阵列内部接口技术比较
 
![1](http://way4ever.com/wp-content/uploads/2013/04/d3.jpg)

***
 
## SAS磁盘和FC磁盘比较--同样参数，仅端口差异

![1](http://way4ever.com/wp-content/uploads/2013/04/d4.jpg)
 
![1](http://way4ever.com/wp-content/uploads/2013/04/d5.jpg)

***
 

## IDE (P-ATA) 并行ATA

含义：Integrated Drive Electronics，即电子集成驱动器，它的本意是指把“硬盘控制器”与“盘体”集成在一起的硬盘驱动器。把盘体与控制器集成在一起的做法减少硬盘接口的电缆数目与长度，数据传输的可靠性得到了增强，硬盘制造起来变得更容易。

40针80芯电缆
 
优点：技术成熟、价格便宜、性能也不差

应用范围：PC
 
![1](http://way4ever.com/wp-content/uploads/2013/04/d6.jpg)
![1](http://way4ever.com/wp-content/uploads/2013/04/d7.jpg)
![1](http://way4ever.com/wp-content/uploads/2013/04/d8.jpg)
![1](http://way4ever.com/wp-content/uploads/2013/04/d9.jpg)

***
 
## SATA (S-ATA)串行ATA

4针电缆
  
特点：以连续串行的方式传送资料

优点：SATA的扩展性更强，由于SATA采用点对点的传输协议，所以不存在主从问题，这样每个驱动器不仅能独享带宽，而且使扩展SATA设备更加便利；如今的SATA接口已经可以完全兼容现有的并行ATA设备，SATA只要利用 一个简单的串/并转换器，就能够实现串/并行ATA设备的随意连接。连接方式简洁，有利于散热。
 
SATA II 是在SATA的基础上发展起来的，其主要特征是外部传输率从SATA的1.5Gbps （150MB/S）进一步提高到 3Gbps（300MB/S），此外还包括NCQ（Native Command Queuing,原生命令队列）。

SATA II的关键技术就是3Gbps的外部传输率和NCQ技术。NCQ技术可以对硬盘的指令执行顺序进行优化，避免像传统硬盘那样机械地按照接受指令的先后顺序 移动磁头读写硬盘的不同位置，与此相反，它会在接受命令后对其进行排序，排序后的磁头将以高效率的顺序进行寻址，从而避免磁头反复移动带来的损耗，延长硬 盘寿命。另外并非所有的SATA硬盘都可以使用NCQ技术，除了硬盘本身要支持NCQ之外，也要求主办芯片组的SATA控制器支持NCQ。此外NCQ技术 不支持FAT文件系统，只支持NTFS文件系统。
 
![1](http://way4ever.com/wp-content/uploads/2013/04/d10.jpg)
![1](http://way4ever.com/wp-content/uploads/2013/04/d11.jpg)
![1](http://way4ever.com/wp-content/uploads/2013/04/d12.jpg)

<table>
    <tr>
        <th>类型</th>
        <th>接口速率(硬盘缓存到主机传输率)</th>
    </tr>
    <tr>
        <td>SATA 1.0</td>
        <td>150MB/S</td>
    </tr>
    <tr>
        <td>SATA 2.0</td>
        <td>300MB/S</td>
    </tr>
    <tr>
        <td>SATA 3.0</td>
        <td>600MB/S</td>
    </tr>
</table>
    
    
***
 
## SCSI

50/68/80针电缆
 
 
 
 
出现原因：主要是因为原来的IDE接口的硬盘转速太慢，传输速率太低，因此高速的SCSI硬盘出现。

特点：其实SCSI并不是专为硬盘设计的，实际上它是一种总线型接口。由于独立于系统总线工作，所以它的最大优势在于其系统占用率极低。

优点：转速快、传输率高、配置灵活（一块SCSI卡上就可以同时挂接15个设备）、高性能（具有多任务、高带宽、CPU占用率低）、向前兼容

缺点：价格高、安装不变、还需要设置及其安装驱动程序。

应用范围：多用于服务器。
 
![1](http://way4ever.com/wp-content/uploads/2013/04/d13.jpg)
![1](http://way4ever.com/wp-content/uploads/2013/04/d14.jpg)
![1](http://way4ever.com/wp-content/uploads/2013/04/d15.jpg)
 
<table>
    <tr>
        <th>类型</th>
        <th>接口速率(硬盘缓存到主机传输率)</th>
    </tr>
    <tr>
        <td>SCSI</td>
        <td></td>
    </tr>
    <tr>
        <td>SCSI-2</td>
        <td>10~20MB/S</td>
    </tr>
    <tr>
        <td>Wide  SCSI -2</td>
        <td></td>
    </tr>
    <tr>
        <td>Ultra  SCSI （SCSI -3） 8位数据通道</td>
        <td>20 MB/S</td>
    </tr>
    <tr>
        <td>Ultra2  SCSI                      8位数据通道</td>
        <td>40 MB/S</td>
    </tr>
    <tr>
        <td>Wide  Ultra2  SCSI           16位数据通道</td>
        <td>80 MB/s</td>
    </tr>
    <tr>
        <td>Ultra160 SCSI </td>
        <td>160MB/S</td>
    </tr>
    <tr>
        <td>Ultra320 SCSI </td>
        <td>320MB/S</td>
    </tr>
</table>
 
 

***
 
## FC 光纤通道
 
 
出现原因：光纤通道最初也不是为硬盘设计开发的接口技术，是专门为网络系统设计的，但随着存储系统对速度的需求，才逐渐应用到硬盘系统中。光纤通道硬盘是为提高多硬盘存储系统的速度和灵活性才开发的。
 
特点：光纤通道的英文拼写是Fibre Channel，和SCIS接口一样光纤通道最初也不是为硬盘设计开发的接口技术，是专门为网络系统设计的
。
优点：热插拔性、高速带宽、远程连接、连接设备数量大。

缺点：产品价格昂贵、组建复杂。

应用范围：存储子系统。
 
 
![1](http://way4ever.com/wp-content/uploads/2013/04/d16.jpg)
![1](http://way4ever.com/wp-content/uploads/2013/04/d17.jpg)

***
 
## SAS

出现原因：SAS（Serial Attached SCSI）即串行连接SCSI，采用串行技术以获得更高的传输速度，并通过缩短连结线改善内部空间。此接口的设计是为了改善存储系统的效能、可用性和扩展性，并且提供与SATA硬盘的兼容性。

优点：

* 更好的性能（采用串行传输代替并行传输，全双工模式）、更简便的连接线缆（将不再使用SCSI那种扁平的宽排线）、更广的扩展性（可与SATA兼容）

兼容性：

* SAS的接口技术可以向下兼容SATA，二者的兼容性主要体现在物理 层和协议层的兼容。在物理层，SAS接口和SATA接口完全兼容，SATA硬盘可以直接使用在SAS的环境中，从接口标准上而言，SATA是SAS的一个 子标准，因此SAS控制器可以直接操控SATA硬盘，但是SAS却不能直接使用在SATA的环境中，因为SATA控制器并不能对SAS硬盘进行控制；在协 议层，SAS由3种类型协议组成，根据连接的不同设备使用相应的协议进行数据传输。其中SCSI协议(SSP)用于传输SCSI命令；SCSI管理协议 SMP用于对连接设备的维护和管理；SATA通道协议（STP）用于SAS和SATA之间数据的传输。因此在这3种协议的配合下，SAS可以和SATA以 及部分SCSI设备无缝结合。
* SAS系统的背板既可以连接具有双端口、高性能的SAS驱动 器，也可以连接高容量、低成本的SATA驱动器。所以SAS驱动器和SATA驱动器可以同时存在于一个存储系统之中。但是需要注意的是，SATA系统并不 兼容SAS，所以SAS驱动器不能连接到SATA背板上。由于SAS系统的兼容性，是用户能够运用不同接口的硬盘来满足各类应用在容量上或效能上的需求， 因此在扩充存储系统时拥有更多的弹性，让存储设备发挥最大的投资效益。
* 在系统中，每一个SAS端口可以最多连接16256个外部设备，并且SAS采用直接的点到点的串行传输方式，传输的速率高达3Gbps，估计以后会有6Gbps乃至12Gbps的告诉接口出现。SAS接口依靠SAS扩展器来连接更多的设备。
* 和传统并行SCSI接口比较起来，SAS不仅在接口速度上得到显著提升（现在主流Ultra 320 SCSI速度为320MB/S,而SAS才刚起步速度就达到300MB/S，未来会达到600MB/S甚至更多），而且由于采用了串行线缆，不仅可以实现更长的连接距离，还能够提高抗干扰能力，并且这种细细的线缆还可以显著改善机箱内部的散热情况。
 
缺点：

* 硬盘、控制芯片种类太少。
* 硬盘价格太高，比起同容量的Ultra 320 SCSI硬盘，SAS硬盘要贵一倍还多。
* 实际传输速度变化不大：SAS硬盘的接口速度并不代表数据传 输速度，受到硬盘机械结构限制，现在SAS硬盘的机械结构和SCSI硬盘几乎一样。目前数据传输的瓶颈集中在由硬盘内部机械结构和硬盘存储技术、磁盘转速 所决定的一个盘内部传输速度，也就是80MB/S左右，SAS硬盘的性能提升不明显。
* 用户追求成熟、稳定的产品。
 
 
SAS技术以串行机制为基础，同时支持SCSI和SATA的协议栈。

![1](http://way4ever.com/wp-content/uploads/2013/04/d18.jpg)

上面的这张照片就是SAS外部接口的样子。SAS外部接口和线缆就是借用了InfiniBand线缆的设计。这种端口名叫“四路宽端口”，以目前3Gb的SAS标准，它可以达到12Gb的带宽，也就是
4 x 3Gb SAS通道。SAS技术与光纤通道一样，都采用8位到10位的编码机制，12Gb的物理层带宽换算到应用层就是1.2GB/S，这一根线就比目前主流的64位133MHz PCI-X还要快。
        
SAS磁盘上的端口也与并行SCSI有很大区别，导师跟SATA磁盘的端口外观非常像。接脚最多的一组是电源接口，接脚较少的一组是SAS磁盘主端口，位置都与SATA磁盘电源和通讯端口完全一致。SAS磁盘与SATA磁盘接口的唯一区别是SAS磁盘还有第二个冗余端口，而SATA磁盘则只有一个端口。
        
如果将SATA磁盘直接插入SAS背板，那么背板上的冗余端口将会悬空，也就是说SATA磁盘只连接在一个控制器上 。这样虽然阵列控制器或主机可以使用这些SATA磁盘，但从结构上将无法实现冗余。        

![1](http://way4ever.com/wp-content/uploads/2013/04/d19.jpg)        
        
为此，一些提供SAS磁盘阵列的厂商，在兼容SATA磁盘时都在SATA磁盘托架上附加一个个的电路板，我们姑且称之为“端口选择器”。其作用就是将SATA磁盘上的单端口与两路SAS同时连接，从而保证前端控制器或主机故障切换时，SATA磁盘仍然能保持连接。
    
![1](http://way4ever.com/wp-content/uploads/2013/04/d20.jpg)

当然物理连接的一致，只是SAS兼容SATA的必要条件。实际上，在整个SAS协议栈中从物理层到应用层，都贯穿着一套用来兼容SATA的协议。这套协议被称为STP（Serial ATA Tunneling Protocol ）即“SATA隧道协议”。从这个命名就可以看出SAS兼容SATA的方式其实就是从磁盘端到主机端整条链路上，为SATA磁盘特地开辟出一条隧道。
 
 
 ![1](http://way4ever.com/wp-content/uploads/2013/04/d21.jpg)
 ![1](http://way4ever.com/wp-content/uploads/2013/04/d22.jpg)
 ![1](http://way4ever.com/wp-content/uploads/2013/04/d23.jpg)


***

## SAS协议：

**SAS协议中重要的三个名词：“设备”(Device)、“端口”(Port)、“phy”。**

“设备”就是指SAS连接末端的物理设备，可以是磁盘，也可以是主机里的SAS适配器，但不是Expander设备。

“端口”是半物理半逻辑的概念。一方面，每个端口都对应一条实实在在的物理连接线；另一方面，每个SAS端口都有一个唯一的64位地址。这个地址的格式跟光纤通道里的WWPN（SAS设备对应WWNN）格式完全相同，由24位公司标志和40位厂商自定义字段构成。

“phy”虽然是个逻辑概念，但功能上很像光纤通道中的SFP。它对应的是一组SAS协议收发单元，由一个发送器和一个接收器组成。每 个phy与远端的另外一个phy连接，构成一发一收两条链路。SAS支持全双工，就是说每个phy在以3Gbps发送的同时，还可以接受3Gbps的流 量。
 
  ![1](http://way4ever.com/wp-content/uploads/2013/04/d24.jpg)
 
每个SAS磁盘可以提供两个SAS端口，每个端口有一个phy，也就是每个SAS磁盘有两个地址，有两个phy。
    
目前主流的SAS适配器一般支持8个phy，可以动态设定适配器支持的端口地址数。当适配器用来连接外部SAS设备时，需要用外部宽端 口，这时适配器将8个phy划分成两个宽度那口，支持两个端口地址。而当适配器连接内部SAS磁盘时，每个phy各自数以自己的端口，适配器将支持8个端 口地址。
    
**SAS技术的重点部分--Expander及其工作原理，才是熟悉SAS技术的关键。**

SAS的连接模式与光纤通道的Fabric交换在很多方面十分相似。每一个SAS Expander就想一台光纤通道交换机，这个交换机构被称为“域”(Domain)，其意义跟光纤通道技术中的“域”几乎完全一样。在光纤通道 Fabric交换结构中，每个域有一个主成员，负责维护整个域的路由信息。在SAS域中，起中心交换作用的Expander叫做“扇出Expander” （Fanout Expander）。SAS域中的“扇出Expander”既可以直接连接终端设备，也能连接其他“边缘 Expander”（Edge Expander）。 唯一与光纤通道Fabric不同的是，SAS域中可以没有“扇出Expander”，而光纤通道Fabric域则不能没有主成员。 没有扇出Expander”的SAS域，最多只可以有两个“边缘 Expander”。

 ![1](http://way4ever.com/wp-content/uploads/2013/04/d25.jpg)

理论上，每个“边缘 Expander”可以支持128个端口，每个SAS域可以有128个“边缘 Expander”，这样每个SAS域中最多可以有128x128=16384个端口。当然，这并不是说每个SAS域可以连接16384个磁盘和SAS适配器，因为“扇出Expander”与“边缘 Expander”相连接时，会占用一部分端口。对比光纤环路126个设备的上限，SAS支持的端口数仍然是非常可观。
    
一些接触过SAS存储产品的读者，可能此时会心存疑惑，为什么SAS单域就可以支持如此众多设备，但实际应用中却经常看到多域模式的产品呢？这其实跟目前SAS芯片的制造工艺有关。如果想制造出一个“扇出Expander”来支持128个“边缘 Expander”的连接，而这款“扇出Expander”至少要支持128个phy（每个端口至少一个phy）。而Expander之间的互联一般应采用至少四路宽端口，那就需要中心的“扇出Expander”支持4x128 =512个phy（每个端口4个phy）。而现在的实际情况是LSI公司的首款SAS芯片只能支持12个phy，刚刚好是个零头。虽然SAS技术支持多个Expander芯片组成一个Expander组（Expander set）来模拟一个Expander，但过多的芯片无疑会在制造工艺和成本方面带来麻烦。正是基于目前SAS芯片工艺水平，一些磁盘阵列厂商在设计陈列扩展时，大多采用多域结构。虽然在软件设计上费力多些，但却可以避开单芯片phy数量有限的问题。
        
所谓的多域模式，在大多数情况下，其实也只不过是两个域而已，即每个阵列控制器各自属于自己的SAS域。因为目前的SAS技术还不支持域之间的路由，所以要想保证每个阵列控制器都能访问到所有磁盘，最多只能引入两个SAS域。

SAS技术借鉴了很多光纤通道技术的工作原理，对比光纤通道技术可以帮助我们更好的了解SAS技术优势。

前面已经提到，SAS端口与光纤通道中的WWN格式几乎完全 一样，但其使用方面还是略有区别。SAS域中，端口地址直接作为交换路由表的内容，没有任何转换过程，而光纤通道的Fabric交换中并不直接采用WWN 地址，而是要经过一个转换过程，由名字服务器对每个设备二次分发路由地址。光纤通道之所以这样设计原因很明显，因为在Fabric交换中要支持环路设备， 所以不得不兼顾各种编址。实际上在光纤通道交换域中，每个设备要经过三层登陆（FLOGI、PLOGI/lOGO、PRLI/PRLO）才能接入域中。这 颇像一个臃肿的官僚机构，虽然体系庞大，却效率低下。而SAS技术舍弃了光纤通道中的仲裁环机制，从而大大简化了交换与地址的关起。在SAS域中，再也不 需要关系那些恼人的繁文缛节了。

由于交换模式的简化，SAS设备与Expander之间不需要通过复杂的磋商，简单的握手之后就开始正常工作了，这就需要双方 事前就很多方面必须达成一致共识。“服务级别”就是共识之一。我们知道光纤通道可以支持5种不同级别的交换服务，分别是Class 1、2、3、4和6。这其中最常用到的是Class 3，即无确认的帧交换。这种模式好比不负责的邮递员，反正有收信人和发信人相互确认，他自己根本不操心包裹是否完好。由于光纤通道技术中没有phy这个层 次的设计，Class 3是效率最高的工作模式。而SAS则不然，借由phy的底层独占式互联机制，SAS中的服务级别更像class 1模式，即虚拟电路全带宽连接。这种模式最能充分保证每一组SAS设备之间的通讯带宽，同时数据的误传输概率也降到最低。

由于光纤通道技术中层次臃肿的通讯机制，主机端光纤适配器很难直接察觉到磁盘端设备状态的变化。就好比一个高高在上的官僚，很 难知道底层普通市民的住址变迁。为此，光纤通道交换设计了“注册状态变更通知”(RSCN)机制。就是让每个普通市民在搬家之后，都要主动向政府汇报新地 址，政府再将地址簿总更新，递交各位领导案头，而官僚们就依据案头的记录信息定位每个市民。遗憾的是，这个RSCN会打断领导们正在进行的沟通，迫使领导 们的工作重新开始，因此严重影响整个政府的办公效率。而在SAS域中，由于没有了复杂的沟通层次，每个领导都可以直接掌握市民的住址信息，办公效率自然就 提高许多。

SAS与光纤通道相比，最明显的技术优势在于连接带宽。简单从数字上看，3Gb的SAS似乎不及4Gb的光纤通道，但是光纤通 道技术中端口已经是最基本的逻辑单元，也就是说，两个物理端口的连接就只可能是4Gb带宽。而SAS则巧妙的在端口中引入phy这个新的逻辑单元，两个 phy之间的互联带宽为3Gb，每个端口可以包含4个或8个phy之多，这样两个SAS端口之间的连接很容易达到12Gb甚至24Gb超高带宽。

总之，SAS在借鉴光纤通道技术特点的同时，一方面大刀阔斧简化交换机制，从而提升力交换效率和可靠性，另一方面增加phy虚拟电路单元，大大增加了性能扩展空间。
    
## SCSI-3指令集
 
正是SCSI-3指令集的出现，使得SCSI通讯出现了分层结构，并使SCSI指令通过其他物理媒介传输成为可能。事实上，SCSI-3指令自诞生之日就被一批新技术相中，此后出现的光纤通道技术、SSA技术、IEEE1394火线技术等，均受益于这一进步。

以下这些串行技术虽然从名字上看与SCSI豪不相干，单其实它们都支持SCSI-3作为应用层逻辑指令。下面是这些串行技术的简要回顾。
 
  ![1](http://way4ever.com/wp-content/uploads/2013/04/d27.jpg)
 
 
***
